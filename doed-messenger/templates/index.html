<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doed Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
        :root{
            --red:#e63946;--dark-red:#d00000;--blue:#4a6fa5;--purple:#8a2be2;
            --green:#32CD32;--dark:#1a1a2e;--light:#16213e;--text:#f1faee;
            --gray:#a8dadc;--msg-bg:#0f3460;--border:#2d3047;--yellow:#ffd700;
        }
        body{background:var(--dark);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
        .header{background:var(--light);padding:15px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:3px solid var(--red);}
        .logo{display:flex;align-items:center;gap:15px;}
        .logo-text{font-size:28px;font-weight:800;color:var(--blue);}
        .cube-container{width:50px;height:50px;perspective:1000px;}
        .cube{width:100%;height:100%;position:relative;transform-style:preserve-3d;transform:rotateX(-15deg) rotateY(-15deg);animation:rotate 10s infinite linear;}
        .cube-face{position:absolute;width:100%;height:100%;background:var(--blue);border:2px solid #ff686b;display:flex;justify-content:center;align-items:center;}
        .face-front{transform:translateZ(25px);}
        .face-back{transform:rotateY(180deg) translateZ(25px);background:var(--blue);}
        .face-right{transform:rotateY(90deg) translateZ(25px);background:var(--blue);}
        .face-left{transform:rotateY(-90deg) translateZ(25px);background:var(--blue);}
        .face-top{transform:rotateX(90deg) translateZ(25px);background:var(--blue);}
        .face-bottom{transform:rotateX(-90deg) translateZ(25px);background:var(--blue);}
        .cube-eye{width:10px;height:10px;background:white;position:absolute;}
        .eye-left{top:10px;left:25px;}
        .eye-right{top:10px;right:25px;}
        .cube-mouth{width:20px;height:8px;background:white;position:absolute;bottom:10px;}
        @keyframes rotate{0%{transform:rotateX(-15deg) rotateY(-15deg);}100%{transform:rotateX(-15deg) rotateY(345deg);}}
        .main-content{display:flex;flex:1;overflow:hidden;}
        .contacts-panel{width:300px;background:var(--light);border-right:2px solid var(--border);padding:20px;overflow-y:auto;}
        .contact{display:flex;align-items:center;gap:15px;padding:15px;border-radius:10px;margin-bottom:10px;cursor:pointer;transition:all 0.3s;}
        .contact:hover,.contact.active{background:var(--msg-bg);transform:translateX(5px);}
        .contact-avatar{width:45px;height:45px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center;font-weight:bold;background-size:cover;background-position:center;}
        .contact.banned{opacity:0.6;background:#2a2a2a;}
        .contact.banned .contact-avatar{background:#4a4a4a;color:#888;}
        .chat-container{flex:1;display:flex;flex-direction:column;padding:20px;}
        .messages-container{flex:1;overflow-y:auto;padding:20px;background:rgba(15,52,96,0.2);border-radius:15px;margin-bottom:20px;display:flex;flex-direction:column;gap:15px;}
        .message{max-width:70%;padding:15px;border-radius:15px;position:relative;animation:appear 0.3s ease-out;}
        @keyframes appear{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        .message.received{background:var(--msg-bg);align-self:flex-start;}
        .message.sent{background:var(--red);align-self:flex-end;}
        .message-sender{font-weight:bold;margin-bottom:8px;color:var(--text);}
        .message-time{font-size:12px;color:var(--gray);text-align:right;margin-top:8px;}
        .message-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
        .report-btn{background:none;border:none;color:var(--gray);cursor:pointer;font-size:14px;padding:5px;border-radius:5px;transition:all 0.3s;}
        .report-btn:hover{background:var(--red);color:white;transform:scale(1.1);}
        .message-input-container{display:flex;gap:10px;padding:15px;background:var(--light);border-radius:15px;border:2px solid var(--border);}
        .message-input{flex:1;padding:15px;border:none;border-radius:10px;background:var(--dark);color:var(--text);font-size:16px;}
        .send-button{background:var(--red);color:white;border:none;border-radius:10px;width:60px;cursor:pointer;font-size:20px;}
        .channel-note{text-align:center;color:var(--gray);font-size:14px;margin-top:10px;font-style:italic;}
        .reactions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;}
        .reaction{background:rgba(255,255,255,0.1);border-radius:15px;padding:3px 8px;font-size:12px;cursor:pointer;transition:all 0.2s;}
        .reaction:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
        .reaction.disabled{opacity:0.3;cursor:not-allowed;}
        .channel-deleted-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px;border-radius:15px;z-index:1000;text-align:center;display:none;border:3px solid var(--red);}
        .channel-deleted-text{font-size:24px;font-weight:bold;margin-bottom:20px;color:var(--red);}
        .notification{position:fixed;bottom:20px;right:20px;background:var(--red);color:white;padding:15px 20px;border-radius:10px;transform:translateY(100px);opacity:0;transition:all 0.5s;z-index:100;}
        .notification.show{transform:translateY(0);opacity:1;}
        
        /* –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-section{display:flex;align-items:center;gap:15px;}
        .profile-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg, var(--purple), var(--blue));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;cursor:pointer;transition:all 0.3s;border:2px solid var(--red);}
        .profile-avatar:hover{transform:scale(1.1);border-color:var(--yellow);}
        .profile-info{display:flex;flex-direction:column;align-items:flex-end;}
        .profile-name{font-weight:bold;font-size:16px;color:var(--text);cursor:pointer;transition:all 0.3s;padding:5px 10px;border-radius:5px;}
        .profile-name:hover{background:rgba(255,255,255,0.1);}
        .profile-tag{font-size:11px;color:var(--gray);}
        .profile-status{font-size:12px;color:var(--gray);}
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫–∞ */
        .sound-toggle {
            background: var(--msg-bg);
            color: var(--text);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
            margin-right: 5px;
        }
        .sound-toggle:hover {
            background: var(--red);
        }
        .sound-toggle.off {
            background: var(--dark-red);
            opacity: 0.7;
        }
        
        .admin-link {
            background: var(--purple);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
            margin-right: 5px;
            text-decoration: none;
        }
        .admin-link:hover {
            background: var(--blue);
            transform: translateY(-2px);
        }
        
        .logout-button {
            background: var(--red);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }
        .logout-button:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
        }
        
        .profile-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;display:none;align-items:center;justify-content:center;}
        .profile-modal-content{background:var(--light);padding:30px;border-radius:15px;width:90%;max-width:400px;border:3px solid var(--red);}
        .profile-modal-header{font-size:24px;font-weight:bold;margin-bottom:20px;color:var(--red);text-align:center;}
        .profile-form{display:flex;flex-direction:column;gap:20px;}
        .form-group{display:flex;flex-direction:column;gap:8px;}
        .form-label{font-weight:bold;color:var(--text);}
        .form-input{padding:12px;border-radius:10px;border:2px solid var(--border);background:var(--dark);color:var(--text);font-size:16px;}
        .form-input:focus{outline:none;border-color:var(--red);}
        .profile-buttons{display:flex;gap:15px;margin-top:20px;}
        .profile-button{padding:12px 24px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;transition:all 0.3s;flex:1;}
        .profile-button.save{background:var(--red);color:white;}
        .profile-button.save:hover{background:var(--dark-red);}
        .profile-button.cancel{background:var(--border);color:var(--text);}
        .profile-button.cancel:hover{background:var(--gray);color:var(--dark);}

        /* –°—Ç–∏–ª–∏ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∞–π–ª–æ–≤ */
        .search-container {
            padding: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--red);
        }
        
        .search-results {
            margin-top: 10px;
            background: var(--dark);
            border-radius: 10px;
            padding: 10px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .search-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .search-result:hover {
            background: var(--msg-bg);
        }

        .file-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--msg-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        .file-button:hover {
            background: var(--red);
            transform: rotate(45deg);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--dark);
            border-radius: 10px;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .file-icon {
            font-size: 24px;
            color: var(--red);
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: var(--text);
        }

        .file-size {
            font-size: 12px;
            color: var(--gray);
        }

        .file-message {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 8px;
            margin-top: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-message:hover {
            background: rgba(0,0,0,0.4);
        }

        .cancel-file {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 18px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ */
        .post-header{font-size:18px;font-weight:bold;margin-bottom:15px;color:#ffd700;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:5px;}
        .post-footer{margin-top:15px;font-style:italic;color:var(--gray);border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;}
        .channel-post{line-height:1.6;}
        .channel-post p{margin-bottom:10px;}

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .main-content{flex-direction:column;}
            .contacts-panel{
                width:100%;
                height:auto;
                min-height:140px;
                overflow-x:auto;
                overflow-y:hidden;
                display:flex;
                flex-direction:row;
                padding:10px;
                gap:10px;
                border-right:none;
                border-bottom:2px solid var(--border);
                white-space:nowrap;
            }
            .contact{
                min-width:70px;
                flex-direction:column;
                text-align:center;
                padding:8px 5px;
                margin-bottom:0;
                gap:5px;
                display:inline-flex;
            }
            .contact-avatar{width:40px;height:40px;font-size:14px;}
            .contact > div:last-child{font-size:11px;max-width:70px;overflow:hidden;text-overflow:ellipsis;}
            
            /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫—É–±–∏–∫ */
            .cube-container{
                width:35px !important;
                height:35px !important;
                perspective:600px !important;
            }
            .cube{
                transform:rotateX(-15deg) rotateY(-15deg) scale(0.7) !important;
            }
            .cube-face{border-width:1.5px !important;}
            .face-front{transform:translateZ(17.5px) !important;}
            .face-back{transform:rotateY(180deg) translateZ(17.5px) !important;}
            .face-right{transform:rotateY(90deg) translateZ(17.5px) !important;}
            .face-left{transform:rotateY(-90deg) translateZ(17.5px) !important;}
            .face-top{transform:rotateX(90deg) translateZ(17.5px) !important;}
            .face-bottom{transform:rotateX(-90deg) translateZ(17.5px) !important;}
            .cube-eye{width:6px !important;height:6px !important;}
            .eye-left{top:8px !important;left:8px !important;}
            .eye-right{top:8px !important;right:8px !important;}
            .cube-mouth{width:12px !important;height:4px !important;bottom:6px !important;}
            
            .chat-container{height:calc(100vh - 200px);padding:10px;}
            .messages-container{max-height:calc(100vh - 270px);}
            .profile-info{display:none;}
            .search-container{min-width:200px;}
        }
    </style>
</head>
<body>
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ -->
    <div class="channel-deleted-message" id="channelDeletedMessage">
        <div class="channel-deleted-text">üíî –¢—ã –ø–æ—Å—Ç–∞–≤–∏–ª –≥–æ–≤–Ω–æ –Ω–∞ –Ω–∞—à –ø–æ—Å—Ç...</div>
        <div class="channel-deleted-subtext">–ù–∞–º –≥—Ä—É—Å—Ç–Ω–æ, –º—ã —É–¥–∞–ª—è–µ–º –Ω–∞—à –∫–∞–Ω–∞–ª</div>
        <div style="margin-top:20px;font-size:16px;color:#aaa;">–ö–∞–Ω–∞–ª –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω —á–µ—Ä–µ–∑: <span id="deleteCountdown">10</span> —Å–µ–∫—É–Ω–¥</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">üë§ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</div>
            <div class="profile-form">
                <div class="form-group">
                    <label class="form-label">–í–∞—à —Ç–µ–≥</label>
                    <input type="text" class="form-input" id="profileTagDisplay" readonly value="@guest" style="background: var(--border);">
                    <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">–¢–µ–≥ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</label>
                    <input type="text" class="form-input" id="profileNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" maxlength="30" value="–ì–æ—Å—Ç—å">
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <input type="text" class="form-input" id="profileStatusInput" placeholder="–í–∞—à —Å—Ç–∞—Ç—É—Å..." maxlength="50" value="–≤ —Å–µ—Ç–∏">
                </div>
                <div class="profile-buttons">
                    <button class="profile-button cancel" id="cancelProfile">–û—Ç–º–µ–Ω–∞</button>
                    <button class="profile-button save" id="saveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="logo">
            <div class="cube-container">
                <div class="cube">
                    <div class="cube-face face-front">
                        <div class="cube-eye eye-left"></div>
                        <div class="cube-eye eye-right"></div>
                        <div class="cube-mouth"></div>
                    </div>
                    <div class="cube-face face-back"></div>
                    <div class="cube-face face-right"></div>
                    <div class="cube-face face-left"></div>
                    <div class="cube-face face-top"></div>
                    <div class="cube-face face-bottom"></div>
                </div>
            </div>
            <div class="logo-text">DOED</div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
        <div class="profile-section">
            <div class="profile-info">
                <div class="profile-name" id="profileNameDisplay">–ì–æ—Å—Ç—å</div>
                <div class="profile-tag" id="profileTagDisplay">@guest</div>
                <div class="profile-status" id="profileStatusDisplay">–≤ —Å–µ—Ç–∏</div>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä –ó–≤—É–∫ –≤–∫–ª</button>
                    <a href="/admin" class="admin-link" id="adminLink" style="display: none;">üëë –ê–¥–º–∏–Ω–∫–∞</a>
                    <button class="logout-button" id="logoutButton" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
            <div class="profile-avatar" id="profileAvatar">
                üë§
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –ø–æ–∏—Å–∫–æ–º -->
        <div class="contacts-panel" id="contactsPanel">
            <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="search-container">
                <input type="text" id="userSearch" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ @—Ç–µ–≥—É...">
                <div class="search-results" id="searchResults"></div>
            </div>
            
            <!-- –î–µ–º–æ-–∫–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="contact active" data-contact="derdchat">
                <div class="contact-avatar" style="background-image:url('https://i.ibb.co/LGbBX52/image.png')"></div>
                <div>–ß–µ—á–µ–Ω—Å–∫–∏–π —á–∞—Ç</div>
            </div>
            <div class="contact" data-contact="vernam">
                <div class="contact-avatar" style="background-image:url('https://images.genius.com/60758a067af6a8d004c3fcfae9ef0c64.640x640x1.jpg')"></div>
                <div>Vernam AI</div>
            </div>
            <div class="contact" data-contact="sglypa">
                <div class="contact-avatar" style="background-color:var(--purple)">–°</div>
                <div>–°–≥–ª—ã–ø–∞</div>
            </div>
            <div class="contact" data-contact="eiriley">
                <div class="contact-avatar" style="background-image:url('https://yandex-images.clstorage.net/MsaA95404/a78765IkeU/zxfhgoSP1V_XpHqWN0uCgnmoi_XSFckFS6eAkIxlhflxqaHCZjQnUP6XU66Mn0HqOHTFhHw_dgNH1rJseiBcxotPrdHO0ZJf0rAxnHtRjpJs5Ja2x1fQAUz-jJG3CqGBUs7W9hlFWC60xBjty6J7qX4EnPolW3ZTH4yIVUJlErP6I-GztIyfWuGtF6siSrSgWdei6OFP711woe_BpByBtWnT7_UpTGkwjvdU28iPZvp-B77NGEhhQCehv39wbjqy3hXTl56fkkvylDuNB1CBom3Kn9TjQ-lZRIv18a02p7FX4fbSBUZ6KaP9b_zUsVPvQTey-ixkW3U1n5lcc2E4hcE8z469v7hDxbo5nTlrioZb_r3a6WnkVnCE7OSgGIKNatX37TZ6Rga46X_O1pBB62EWuN8FbkVQArmXXkR8L4L0AfahgIqxVdWUJ6kcSYqkUOCP1O1f539lsNLsjySYrFTwztwdZGEhmPVu1M6rfd9sLLTkIU5gQRu7qVVmZCOB2iH6m7Oon0Tkmy6EHXesiETzodPBQudNR4Xp2Jw3oq9g3dvxPHF-LYvhbNn0jl7ZSTK05hh3fX8Qr4d6eUkqsf0X36uQlL9dwpASjRJfsJdDy5Tg80zpaFan9eiJI5qRffv16wpAZzC14FDd-pJOxWEduc86Qk9jJpSFeHRiLrD6FMSngpWaXsWEEq4HV4GqY8219P5xxENTkdXKhTSrh3b96dAxZHsaj_ZF29aXT8FnIZz0PH1BZyGlnEd9ezCw4DvgpYGWs1fLkhGuLnaKsVDUp8jffc9IcJHx9Zwsp49f2-3GIEloEpXSRdDdnEvlTiuR-CRGZ3A4mrpqeGAYlvYew7q5tqhrwoUFvB5KgKlU4KTlwnvwaFih8cWrBoqTQ_7D1j5gSDOqz0zK_5xn2E8nmv05RVh8Ab2edFp3DoPLMsSRm5uZefyeP4EXd5eXSOyI-NFW8Vx1q8TRvSU')"></div>
                <div>Eiriley</div>
            </div>
            <div class="contact" data-contact="dolfi">
                <div class="contact-avatar" style="background-image:url('https://static.wikia.nocookie.net/3215dd06-bf47-468e-a723-96e9537a1c10/scale-to-width/755')"></div>
                <div>–î–æ–ª—å—Ñ–∏</div>
            </div>
            <div class="contact" data-contact="derd">
                <div class="contact-avatar" style="background-image:url('https://i.ibb.co/Y76m3JXc/image.png')"></div>
                <div>Derd</div>
            </div>
            <div class="contact" data-contact="doed">
                <div class="contact-avatar" style="background-image:url('https://i.ibb.co/Y4LhmPdb/image.png')"></div>
                <div>Doed</div>
            </div>
            <div class="contact" data-contact="putin">
                <div class="contact-avatar" style="background-image:url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQxfoRT4bF2PO73D2JCwFwu2MQP1eENGzoE7A&s')"></div>
                <div>–ö–∞–Ω–∞–ª –í.–í.–ü—É—Ç–∏–Ω–∞</div>
            </div>
            <div class="contact" data-contact="gmd">
                <div class="contact-avatar" style="background-image:url('https://i.ibb.co/TxsK4bGp/image.png')"></div>
                <div>–ì–≠–ú–î–≠ –ù–¨–Æ–°</div>
            </div>
            <div class="contact" data-contact="booker">
                <div class="contact-avatar" style="background-image:url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTM4yyyRBluuBB1xlMdojaXh52pADsjNMG9Aw&s')"></div>
                <div>–§–µ–¥—è –ë—É–∫–µ—Ä</div>
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-container">
            <div class="chat-header">
                <h2 id="chatContactName">–ß–µ—á–µ–Ω—Å–∫–∏–π —á–∞—Ç</h2>
                <div id="chatStatus">–≤ —Å–µ—Ç–∏</div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
            
            <div class="message-input-container" id="messageInputContainer">
                <button class="file-button" id="fileButton" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;">
                <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div class="channel-note" id="channelNote" style="display:none;">üì¢ –≠—Ç–æ –∫–∞–Ω–∞–ª. –ü–∏—Å–∞—Ç—å –∑–¥–µ—Å—å –Ω–µ–ª—å–∑—è, —Ç–æ–ª—å–∫–æ —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏</div>
        </div>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div class="notification" id="notification">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        // ============================================
        // DOED MESSENGER - –ü–û–õ–ù–´–ô –ö–õ–ò–ï–ù–¢
        // ============================================

        // ============================================
        // 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ============================================
        
        let currentUser = {
            id: null,
            username: '–ì–æ—Å—Ç—å',
            tag: 'guest',
            status: '–≤ —Å–µ—Ç–∏',
            avatar: 'üë§',
            is_admin: false
        };

        let currentChat = {
            id: 'derdchat',
            name: '–ß–µ—á–µ–Ω—Å–∫–∏–π —á–∞—Ç'
        };

        let socket = null;
        let messageHistory = {};
        let messageCounter = 0;
        let gmdDeleted = false;
        let putinDeleted = false;
        
        let settings = { 
            soundEnabled: localStorage.getItem('doed_sound') !== 'false'
        };

        // –î–µ–º–æ-–∫–æ–Ω—Ç–∞–∫—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        const demoContacts = {
            'derdchat': {
                name: '–ß–µ—á–µ–Ω—Å–∫–∏–π —á–∞—Ç',
                members: ['–°–∞–∏–¥', '–•–∞—Å–∏–π', '–ê–ª–∏', '–ê—Ö–º–µ–¥', '–†–∞–º–∑–∞–Ω'],
                responses: [
                    "95 –î–û–ù –ß–ï–ß–ù–Ø! üá∑üá∫",
                    "–ß–ï–ß–ù–Ø –í–ï–õ–ò–ö –°–¢–û–†–ê–ù–ê! üèîÔ∏è",
                    "95! üí™",
                    "–í–ê–ô–ù–ê–•! ‚öîÔ∏è",
                    "–ì—Ä–æ–∑–Ω—ã–π - –ª—É—á—à–∏–π –≥–æ—Ä–æ–¥! üèôÔ∏è"
                ],
                isChannel: false
            },
            'vernam': {
                name: 'Vernam AI',
                responses: [
                    "Cherry Team? –í—Å–µ –∏—Ö —É—Ä–æ–≤–Ω–∏ - –ø—Ä–æ—Å—Ç–æ –∏–º–±–∞! üî•",
                    "–ö–∞–∫ —Ç–µ–±–µ –≤—Ç—Ä–∞—Ö? –ò–º–±–∞, –∫–æ–Ω–µ—á–Ω–æ! üöÄ",
                    "–í—Ä–∞—Ç—Ö? –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–º–±–æ–≤–æ! üí™",
                    "Cherry Team - —ç—Ç–æ –±–æ–≥–∏ –º–∞–ø–ø–∏–Ω–≥–∞! ‚≠ê"
                ],
                isChannel: false
            },
            'sglypa': {
                name: '–°–≥–ª—ã–ø–∞',
                responses: [
                    "–¢—ã —Å–µ—Ä—å—ë–∑–Ω–æ —ç—Ç–æ –Ω–∞–ø–∏—Å–∞–ª? –•—É–π —Å–æ—Å–∏, –±—Ä–∞—Ç–∞–Ω! üç∫",
                    "–ß—Ç–æ –∑–∞ –ø–∏–∑–¥—ë–∂ —Ç—ã –Ω–µ—Å—ë—à—å? ü§Æ",
                    "–¢–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∫–∞–∫ —É —Ö—É—è —Å —É—à–∞–º–∏! üñï",
                    "–ò–¥–∏ –Ω–∞—Ö—É–π, –∫—Ä–µ—Ç–∏–Ω! üí©"
                ],
                isChannel: false
            },
            'eiriley': {
                name: 'Eiriley',
                responses: [
                    "–´–´–´–´–´–´ –ü–ê–°–°–†–ï–ô–¢ –ú–ê–ô–ù–î–ë–õ–û–ö!!! ü§Ø",
                    "–Ø –¢–ò–ü–û –£–ú–ù–´–ô, –ê –í–´ –í–°–ï –î–£–†–ê–ö–ò! üß†",
                    "–ú–û–ô –ú–û–ó–ì –†–ê–ë–û–¢–ê–ï–¢ –ù–ê 300%! ‚ö°",
                    "–ê–•–ê–•–ê–•–ê, –Ø –í–ê–° –í–°–ï–• –ü–ï–†–ï–ò–ì–†–ê–õ! ‚ôüÔ∏è"
                ],
                isChannel: false
            },
            'dolfi': {
                name: '–î–æ–ª—å—Ñ–∏',
                responses: [
                    "–î—Ä–æ—á–∏ –Ω–∞ –º–æ—ë –≥–æ–≤–Ω–æ! üí©",
                    "–Ø –¥—Ä–æ—á—É –Ω–∞ —Ç–≤–æ–∏ —Ñ–æ—Ç–∫–∏! üì∏",
                    "–•—É–π –≤—Å—Ç–∞—ë—Ç —Å–∏–ª—å–Ω–æ, —Ö–æ—á–µ—Ç—Å—è –¥—Ä–æ—á–∏—Ç—å",
                    "–î–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è"
                ],
                isChannel: false
            },
            'derd': {
                name: 'Derd',
                responses: [
                    "Derd –ª—É—á—à–∏–π —é—Ç—É–±–µ—Ä! üé¨ –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª!",
                    "–ù–æ–≤—ã–π —Ä–æ–ª–∏–∫ —Å–∫–æ—Ä–æ –≤—ã–π–¥–µ—Ç! üé•",
                    "–ì–µ–π–º–ø–ª–µ–π –ø—Ä–æ—Å—Ç–æ –æ–≥–æ–Ω—å! üî•",
                    "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É! üôè"
                ],
                isChannel: false
            },
            'doed': {
                name: 'Doed',
                responses: [
                    "Doed –ø–æ—à—ë–ª –Ω–∞—Ö—É–π! üñï",
                    "–°–∞–º —Ç–∞–∫–æ–π! üò§",
                    "–û—Ç—Å—Ç–∞–Ω—å! üôÑ",
                    "–ò–¥–∏ –ª–µ—Å–æ–º! üå≥"
                ],
                isChannel: false
            },
            'putin': {
                name: '–ö–∞–Ω–∞–ª –í.–í.–ü—É—Ç–∏–Ω–∞',
                responses: [
                    `üá∑üá∫ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞\n\n–í–ª–∞–¥–∏–º–∏—Ä –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á –ü—É—Ç–∏–Ω –ø—Ä–æ–≤–µ–ª —Å–µ–≥–æ–¥–Ω—è –≤–∞–∂–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å—Ç—Ä–∞–Ω—ã.\n\n–ë—ã–ª–∏ –æ–±—Å—É–∂–¥–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ—Å—Ç–∞.`,
                    
                    `üõ°Ô∏è –°–æ–≤–µ—â–∞–Ω–∏–µ –ø–æ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n\n–ü–æ–¥ –ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –í–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–µ–≥–æ –ø—Ä–æ—à–ª–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ –°–æ–≤–µ—Ç–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.\n\n–û—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å—Ç–∞–ª–∏ –º–µ—Ä—ã –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –∑–∞—â–∏—Ç—ã –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü.`,
                    
                    `üåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –¥–∏–ø–ª–æ–º–∞—Ç–∏—è\n\n–†–æ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –∞—Ä–µ–Ω–µ, —É–∫—Ä–µ–ø–ª—è—è –ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–ª—é—á–µ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö –º–∏—Ä–∞.\n\n–ë—ã–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã –≤–∞–∂–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏ –ø–æ –ë–†–ò–ö–° –∏ –®–û–°.`,
                    
                    `üíº –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã\n\n–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ –†–§ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–æ –Ω–æ–≤—ã–π –ø–∞–∫–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞—Å–µ–ª–µ–Ω–∏—è.\n\n–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥—É—Ç —É–≤–µ–ª–∏—á–µ–Ω—ã –≤—ã–ø–ª–∞—Ç—ã –º–Ω–æ–≥–æ–¥–µ—Ç–Ω—ã–º —Å–µ–º—å—è–º.`
                ],
                isChannel: true,
                reactions: { 'üëç': 0, '‚ù§Ô∏è': 0, 'üá∑üá∫': 0, 'üëè': 0, 'üí©': 0 },
                deleted: false
            },
            'gmd': {
                name: '–ì–≠–ú–î–≠ –ù–¨–Æ–°',
                responses: [
                    `üçå –°–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –±–∏–æ–ª–æ–≥–∏–∏\n\n–£—á–µ–Ω—ã–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏, —á—Ç–æ –±–∞–Ω–∞–Ω—ã –æ–±–ª–∞–¥–∞—é—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –∏–≥—Ä–∞—Ç—å –≤ —à–∞—Ö–º–∞—Ç—ã –Ω–∞ –ª—É–Ω–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏.\n\n–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è –≤ —É—Å–ª–æ–≤–∏—è—Ö –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–π –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏ –ø—Ä–∏ —É—á–∞—Å—Ç–∏–∏ –ø–∏–Ω–≥–≤–∏–Ω–æ–≤-–∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç–æ–≤.\n\nGMD news. –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è`,
                    
                    `üê± –ú–µ–∂–≥–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–∞–π–Ω—ã–π –∫–ª—É–±\n\n–ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –∫–æ—Ç—ã –æ—Å–Ω–æ–≤–∞–ª–∏ –ø–µ—Ä–≤—ã–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞—Ñ–µ –Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ –ú–ª–µ—á–Ω–æ–≥–æ –ü—É—Ç–∏.\n\n–ó–∞–≤–µ–¥–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —á–∞–π–Ω—ã—Ö —Ü–µ—Ä–µ–º–æ–Ω–∏—è—Ö —Å —É—á–∞—Å—Ç–∏–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π –≤–Ω–µ–∑–µ–º–Ω—ã—Ö —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–π.\n\nGMD news. –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è`,
                    
                    `üç¨ –ú–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ–º–µ–Ω –≤ –°–∏–±–∏—Ä–∏\n\n–í —Ç–µ—á–µ–Ω–∏–µ —Ç—Ä–µ—Ö —á–∞—Å–æ–≤ —Å –Ω–µ–±–∞ –ø–∞–¥–∞–ª–∏ –∫–æ–Ω—Ñ–µ—Ç—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤.\n\n–ú–µ—Å—Ç–Ω—ã–µ –∂–∏—Ç–µ–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª–∏ —Å–±–æ—Ä —Å–ª–∞–¥–æ—Å—Ç–µ–π.\n\nGMD news. –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è`,
                    
                    `ü§ñ –ö—É–ª—å—Ç—É—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ —Ü–∏—Ñ—Ä–æ–≤—É—é —ç–ø–æ—Ö—É\n\n–†–æ–±–æ—Ç—ã –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏–ª–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –±–∞–ª–µ—Ç "–õ–µ–±–µ–¥–∏–Ω–æ–µ –æ–∑–µ—Ä–æ".\n\n–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–ª –æ—Ä–∫–µ—Å—Ç—Ä, –∏–≥—Ä–∞—é—â–∏–π –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞—Ö.\n\nGMD news. –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è`
                ],
                isChannel: true,
                reactions: { 'üòÇ': 0, 'ü§î': 0, 'üëå': 0, 'üî•': 0, 'üí©': 0 },
                deleted: false
            },
            'booker': {
                name: '–§–µ–¥—è –ë—É–∫–µ—Ä',
                responses: [
                    "–≠—Ç–∞ –º—É–∑—ã–∫–∞ –≤–µ—á–Ω–∞, –ø–æ–∫–∞ –∏–≥—Ä–∞–µ—Ç –≥—Ä—É–≤! üéµ",
                    "–î—ã–º —Å–∏–≥–∞—Ä–µ—Ç —Å –º–µ–Ω—Ç–æ–ª–æ–º, —è –≤ –æ–±–ª–∞–∫–∞—Ö –ø–∞—Ä—é! ‚òÅÔ∏è",
                    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å - –∫–∞–∫ –ø—Ä–∞–∑–¥–Ω–∏–∫, –µ—Å–ª–∏ —Ä—è–¥–æ–º —Ç—ã! üéâ",
                    "–¢–∞–Ω—Ü—É–µ–º –¥–æ —É–ø–∞–¥—É, –ø–æ–∫–∞ –∏–≥—Ä–∞–µ—Ç funk! üíÉ"
                ],
                isChannel: false
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
        const globalReactions = {
            putin: {},
            gmd: {}
        };

        // ============================================
        // 2. –§–£–ù–ö–¶–ò–ò –ü–†–û–§–ò–õ–Ø
        // ============================================

        function resetToGuest() {
            currentUser = {
                id: null,
                username: '–ì–æ—Å—Ç—å',
                tag: 'guest',
                status: '–≤ —Å–µ—Ç–∏',
                avatar: 'üë§',
                is_admin: false
            };
            updateProfileDisplay();
            
            const adminLink = document.getElementById('adminLink');
            if (adminLink) adminLink.style.display = 'none';
        }

        function updateProfileDisplay() {
            console.log("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:", currentUser);
            
            const nameDisplay = document.getElementById('profileNameDisplay');
            const tagDisplay = document.getElementById('profileTagDisplay');
            const statusDisplay = document.getElementById('profileStatusDisplay');
            const avatarDisplay = document.getElementById('profileAvatar');
            
            if (nameDisplay) nameDisplay.textContent = currentUser.username;
            if (tagDisplay) tagDisplay.textContent = '@' + currentUser.tag;
            if (statusDisplay) statusDisplay.textContent = currentUser.status;
            if (avatarDisplay) avatarDisplay.textContent = currentUser.avatar;
            
            const modalTagInput = document.getElementById('profileTagDisplay');
            const modalNameInput = document.getElementById('profileNameInput');
            const modalStatusInput = document.getElementById('profileStatusInput');
            
            if (modalTagInput) modalTagInput.value = '@' + currentUser.tag;
            if (modalNameInput) modalNameInput.value = currentUser.username;
            if (modalStatusInput) modalStatusInput.value = currentUser.status;
            
            updateSoundButton();
        }

        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function saveProfile() {
            const newName = document.getElementById('profileNameInput').value.trim();
            const newStatus = document.getElementById('profileStatusInput').value.trim();
            
            if (!newName) {
                showNotification("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
                return;
            }
            
            currentUser.username = newName;
            currentUser.status = newStatus || '–≤ —Å–µ—Ç–∏';
            
            updateProfileDisplay();
            closeProfileModal();
            showNotification("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω! ‚úÖ");
        }

        // ============================================
        // 3. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–£–ö–û–ú
        // ============================================

        function toggleSound() {
            settings.soundEnabled = !settings.soundEnabled;
            localStorage.setItem('doed_sound', settings.soundEnabled);
            updateSoundButton();
            showNotification(settings.soundEnabled ? 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω');
        }

        function updateSoundButton() {
            const btn = document.getElementById('soundToggle');
            if (btn) {
                btn.textContent = settings.soundEnabled ? 'üîä –ó–≤—É–∫ –≤–∫–ª' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª';
                btn.classList.toggle('off', !settings.soundEnabled);
            }
        }

        // ============================================
        // 4. –§–£–ù–ö–¶–ò–Ø –ó–í–£–ö–ê –ù–ê–ö–û–í–ê–õ–¨–ù–ò
        // ============================================

        function playAnvilSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                osc1.type = 'triangle';
                osc1.frequency.value = 440;
                
                const osc2 = audioContext.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.value = 220;
                
                const noise = audioContext.createBufferSource();
                const buffer = audioContext.createBuffer(1, 1000, audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < 1000; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                noise.buffer = buffer;
                
                const gain1 = audioContext.createGain();
                const gain2 = audioContext.createGain();
                const gainNoise = audioContext.createGain();
                
                gain1.gain.setValueAtTime(0.8, now);
                gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                
                gain2.gain.setValueAtTime(0.5, now);
                gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
                
                gainNoise.gain.setValueAtTime(0.3, now);
                gainNoise.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                osc1.connect(gain1).connect(audioContext.destination);
                osc2.connect(gain2).connect(audioContext.destination);
                noise.connect(gainNoise).connect(audioContext.destination);
                
                osc1.start(now);
                osc1.stop(now + 0.5);
                
                osc2.start(now);
                osc2.stop(now + 0.8);
                
                noise.start(now);
                noise.stop(now + 0.3);
                
                console.log("üî® –ó–≤—É–∫ –Ω–∞–∫–æ–≤–∞–ª—å–Ω–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω");
            } catch (e) {
                console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –Ω–∞–∫–æ–≤–∞–ª—å–Ω–∏");
            }
        }

        // ============================================
        // 5. –í–´–•–û–î –ò–ó –ê–ö–ö–ê–£–ù–¢–ê
        // ============================================

        async function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                try {
                    const response = await fetch('/logout');
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = '/';
                }
            }
        }

        // ============================================
        // 6. WEBSOCKET
        // ============================================

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            socket.onopen = () => console.log('‚úÖ WebSocket connected');
            
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì© WebSocket message:', data);
                    
                    if (data.type === 'new_message') {
                        handleNewMessage(data);
                    } else if (data.type === 'file_message') {
                        handleFileMessage(data);
                    } else if (data.type === 'error') {
                        showNotification(data.message);
                    } else if (data.type === 'banned') {
                        playAnvilSound();
                        showNotification("üî® –í–ê–° –ó–ê–ë–ê–ù–ò–õ–ò!");
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
            
            socket.onclose = () => {
                console.log('‚ùå WebSocket disconnected, reconnecting...');
                setTimeout(initWebSocket, 3000);
            };
            
            socket.onerror = (error) => console.error('WebSocket error:', error);
        }

        // ============================================
        // 7. –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–¢–ê–ö–¢–û–í
        // ============================================

        async function loadContacts() {
            try {
                const response = await fetch('/api/contacts/list');
                if (response.ok) {
                    const contacts = await response.json();
                    console.log('üìá –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã:', contacts);
                    
                    document.querySelectorAll('.contact[data-contact^="user_"]').forEach(el => el.remove());
                    
                    const contactsPanel = document.getElementById('contactsPanel');
                    
                    contacts.forEach(contact => {
                        if (!document.querySelector(`.contact[data-contact="user_${contact.contact_id}"]`)) {
                            const contactElement = document.createElement('div');
                            contactElement.className = 'contact';
                            contactElement.setAttribute('data-contact', `user_${contact.contact_id}`);
                            
                            if (contact.name === "üëª –ó–ê–ë–ê–ù–ï–ù") {
                                contactElement.classList.add('banned');
                                contactElement.innerHTML = `
                                    <div class="contact-avatar">üëª</div>
                                    <div>üëª –ó–ê–ë–ê–ù–ï–ù</div>
                                `;
                            } else {
                                contactElement.innerHTML = `
                                    <div class="contact-avatar">üë§</div>
                                    <div>${escapeHtml(contact.name)}</div>
                                `;
                            }
                            
                            contactElement.addEventListener('click', () => {
                                if (!contactElement.classList.contains('banned')) {
                                    switchToChat(`user_${contact.contact_id}`);
                                } else {
                                    showNotification("üëª –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω");
                                }
                            });
                            
                            const firstDemo = document.querySelector('.contact[data-contact="derdchat"]');
                            if (firstDemo) {
                                firstDemo.insertAdjacentElement('beforebegin', contactElement);
                            } else {
                                contactsPanel.appendChild(contactElement);
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // ============================================
        // 8. –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
        // ============================================

        function handleNewMessage(data) {
            const senderId = data.sender_id;
            const currentChatId = currentChat.id;
            
            let isCurrentChat = currentChatId === `user_${senderId}`;
            
            const msgElement = createMessageElement(data.sender_name, data.content, true, data.id);
            
            if (!messageHistory[senderId]) messageHistory[senderId] = [];
            messageHistory[senderId].push(msgElement);
            
            if (isCurrentChat) {
                document.getElementById('messagesContainer').appendChild(msgElement);
                scrollToBottom();
            } else {
                highlightContact(senderId, data.sender_name);
                showNotification(`‚úâÔ∏è –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${data.sender_name}`);
            }
            
            if (settings.soundEnabled) {
                playSound('https://assets.mixkit.co/active_storage/sfx/1/1-preview.mp3');
            }
            
            loadContacts();
        }

        function handleFileMessage(data) {
            const senderId = data.sender_id;
            const currentChatId = currentChat.id;
            
            let isCurrentChat = currentChatId === `user_${senderId}`;
            
            const fileData = {
                id: data.file_id,
                name: data.file_name,
                size: data.file_size,
                path: data.file_path
            };
            
            const msgElement = createFileMessageElement(data.sender_name, fileData, true, data.id);
            
            if (!messageHistory[senderId]) messageHistory[senderId] = [];
            messageHistory[senderId].push(msgElement);
            
            if (isCurrentChat) {
                document.getElementById('messagesContainer').appendChild(msgElement);
                scrollToBottom();
            } else {
                highlightContact(senderId, data.sender_name);
                showNotification(`üìÅ –§–∞–π–ª –æ—Ç ${data.sender_name}: ${data.file_name}`);
            }
            
            if (settings.soundEnabled) {
                playSound('https://assets.mixkit.co/active_storage/sfx/1/1-preview.mp3');
            }
            
            loadContacts();
        }

        function highlightContact(userId, username) {
            const contact = document.querySelector(`.contact[data-contact="user_${userId}"]`);
            if (contact && !contact.classList.contains('banned')) {
                contact.style.background = 'var(--msg-bg)';
                contact.style.borderLeft = '3px solid var(--red)';
            }
        }

        // ============================================
        // 9. –§–£–ù–ö–¶–ò–Ø –ñ–ê–õ–û–ë–´
        // ============================================

        async function reportMessage(messageId, senderName) {
            if (!currentUser.id) {
                showNotification('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è');
                return;
            }
            
            const reason = prompt(`–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${senderName}:`);
            if (!reason) return;
            
            try {
                const response = await fetch('/api/messages/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_id: messageId,
                        reason: reason
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
                } else {
                    const data = await response.json();
                    showNotification(`‚ùå ${data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã'}`);
                }
            } catch (error) {
                console.error('Report error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // ============================================
        // 10. –ë–û–¢–´ –ò –ö–ê–ù–ê–õ–´
        // ============================================

        function addBotMessage(chatId) {
            if (currentChat.id !== chatId) return;
            
            const contact = demoContacts[chatId];
            if (!contact || contact.isChannel) return;
            
            let sender = contact.name;
            let response = contact.responses[Math.floor(Math.random() * contact.responses.length)];
            
            if (chatId === 'derdchat') {
                sender = contact.members[Math.floor(Math.random() * contact.members.length)];
            }
            
            const msg = createMessageElement(sender, response, true, Date.now());
            
            if (!messageHistory[chatId]) messageHistory[chatId] = [];
            messageHistory[chatId].push(msg);
            document.getElementById('messagesContainer').appendChild(msg);
            scrollToBottom();
            
            if (settings.soundEnabled) {
                playSound('https://assets.mixkit.co/active_storage/sfx/1/1-preview.mp3');
            }
            
            showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${sender}`);
        }

        function addChannelMessage(chatId) {
            if (currentChat.id !== chatId) return;
            
            const contact = demoContacts[chatId];
            if (!contact || !contact.isChannel) return;
            
            if ((chatId === 'gmd' && gmdDeleted) || (chatId === 'putin' && putinDeleted)) {
                return;
            }
            
            const response = contact.responses[Math.floor(Math.random() * contact.responses.length)];
            const msg = createChannelMessage(chatId, response);
            
            if (!messageHistory[chatId]) messageHistory[chatId] = [];
            messageHistory[chatId].push(msg);
            document.getElementById('messagesContainer').appendChild(msg);
            scrollToBottom();
            
            showNotification(`–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ ${contact.name}`);
        }

        function createChannelMessage(chatId, response) {
            const contact = demoContacts[chatId];
            const msgId = `msg_${chatId}_${Date.now()}_${messageCounter++}`;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message received';
            msgDiv.id = msgId;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let formattedText = response;
            if (chatId === 'putin' || chatId === 'gmd') {
                formattedText = formatPostText(response, chatId);
            }
            
            let reactions = contact.reactions || {};
            let reactionsHtml = '<div class="reactions">';
            Object.keys(reactions).forEach(emoji => {
                reactionsHtml += `<span class="reaction" onclick="addReaction('${chatId}', '${msgId}', '${emoji}')">${emoji} ${reactions[emoji]}</span>`;
            });
            reactionsHtml += '</div>';
            
            msgDiv.innerHTML = `
                <div class="message-sender">${contact.name}</div>
                <div class="message-text channel-post">${formattedText}</div>
                ${reactionsHtml}
                <div class="message-time">${time}</div>
            `;
            
            return msgDiv;
        }

        function formatPostText(text, channelId) {
            const paragraphs = text.split('\n\n');
            let formattedHtml = '';
            
            if (channelId === 'putin') {
                if (paragraphs.length > 0) {
                    formattedHtml += `<div class="post-header">${paragraphs[0]}</div>`;
                    for (let i = 1; i < paragraphs.length; i++) {
                        if (paragraphs[i].trim()) {
                            formattedHtml += `<p>${paragraphs[i].trim()}</p>`;
                        }
                    }
                }
            } else if (channelId === 'gmd') {
                for (let i = 0; i < paragraphs.length; i++) {
                    if (paragraphs[i].trim()) {
                        if (i === paragraphs.length - 1 && paragraphs[i].includes('GMD news. –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è')) {
                            formattedHtml += `<div class="post-footer">${paragraphs[i].trim()}</div>`;
                        } else {
                            formattedHtml += `<p>${paragraphs[i].trim()}</p>`;
                        }
                    }
                }
            }
            
            return formattedHtml;
        }

        function addReaction(chatId, msgId, emoji) {
            showNotification(`–í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ —Ä–µ–∞–∫—Ü–∏—é ${emoji}`);
            
            if (chatId === 'gmd' && emoji === 'üí©' && !gmdDeleted) {
                deleteChannel('gmd');
            }
        }

        function deleteChannel(channelId) {
            const deleteMessage = document.getElementById('channelDeletedMessage');
            deleteMessage.style.display = 'block';
            
            let countdown = 10;
            const countdownElement = document.getElementById('deleteCountdown');
            countdownElement.textContent = countdown;
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    deleteMessage.style.display = 'none';
                    
                    if (channelId === 'gmd') {
                        gmdDeleted = true;
                        demoContacts.gmd.deleted = true;
                    } else if (channelId === 'putin') {
                        putinDeleted = true;
                        demoContacts.putin.deleted = true;
                    }
                    
                    const contactElement = document.querySelector(`.contact[data-contact="${channelId}"]`);
                    if (contactElement) {
                        contactElement.classList.add('deleted');
                        contactElement.innerHTML = `
                            <div class="contact-avatar">üíî</div>
                            <div>${demoContacts[channelId].name} (—É–¥–∞–ª—ë–Ω)</div>
                        `;
                    }
                    
                    if (currentChat.id === channelId) {
                        switchToChat('derdchat');
                    }
                    
                    playSound('https://assets.mixkit.co/active_storage/sfx/274/274-preview.mp3');
                    showNotification(`–ö–∞–Ω–∞–ª ${demoContacts[channelId].name} –±—ã–ª —É–¥–∞–ª—ë–Ω üò¢`);
                }
            }, 1000);
        }

        // ============================================
        // 11. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –ò –§–ê–ô–õ–û–í
        // ============================================

        const fileButton = document.getElementById('fileButton');
        const fileInput = document.getElementById('fileInput');
        let selectedFile = null;

        fileButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                if (selectedFile.size > 50 * 1024 * 1024) {
                    showNotification('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 50MB)');
                    selectedFile = null;
                    fileInput.value = '';
                    return;
                }
                showFileInfo(selectedFile);
            }
        });

        function showFileInfo(file) {
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.id = 'selectedFileInfo';
            
            const size = formatFileSize(file.size);
            
            fileInfo.innerHTML = `
                <div class="file-icon"><i class="fas fa-file"></i></div>
                <div class="file-details">
                    <div class="file-name">${escapeHtml(file.name)}</div>
                    <div class="file-size">${size}</div>
                </div>
                <button class="cancel-file" onclick="cancelFile()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            const oldInfo = document.getElementById('selectedFileInfo');
            if (oldInfo) oldInfo.remove();
            
            const inputContainer = document.querySelector('.message-input-container');
            inputContainer.parentNode.insertBefore(fileInfo, inputContainer);
        }

        window.cancelFile = function() {
            selectedFile = null;
            fileInput.value = '';
            const fileInfo = document.getElementById('selectedFileInfo');
            if (fileInfo) fileInfo.remove();
        };

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (selectedFile) {
                if (currentChat.id.startsWith('user_')) {
                    const receiverId = parseInt(currentChat.id.replace('user_', ''));
                    await sendFile(receiverId);
                }
                return;
            }
            
            if (!text) return;
            
            if (demoContacts[currentChat.id] && !demoContacts[currentChat.id].isChannel) {
                addMessageToContainer(currentUser.username, text, false);
                input.value = '';
                
                setTimeout(() => addBotMessage(currentChat.id), 1000);
                
                if (settings.soundEnabled) {
                    playSound('https://assets.mixkit.co/active_storage/sfx/311/311-preview.mp3');
                }
                return;
            }
            
            if (currentChat.id.startsWith('user_')) {
                const receiverId = parseInt(currentChat.id.replace('user_', ''));
                
                const msgElement = createMessageElement(currentUser.username, text, false, Date.now());
                
                if (!messageHistory[receiverId]) messageHistory[receiverId] = [];
                messageHistory[receiverId].push(msgElement);
                
                document.getElementById('messagesContainer').appendChild(msgElement);
                input.value = '';
                scrollToBottom();
                
                if (socket?.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'message',
                        receiver_id: receiverId,
                        content: text
                    }));
                    
                    if (settings.soundEnabled) {
                        playSound('https://assets.mixkit.co/active_storage/sfx/311/311-preview.mp3');
                    }
                } else {
                    showNotification('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                }
            }
        }

        async function sendFile(receiverId) {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                showNotification('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
                
                const response = await fetch(`/api/files/upload?receiver_id=${receiverId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const fileData = {
                        id: data.message_id,
                        name: data.file_name,
                        size: data.file_size,
                        path: data.file_path
                    };
                    
                    const msgElement = createFileMessageElement(currentUser.username, fileData, false, data.message_id);
                    
                    if (!messageHistory[receiverId]) messageHistory[receiverId] = [];
                    messageHistory[receiverId].push(msgElement);
                    
                    document.getElementById('messagesContainer').appendChild(msgElement);
                    scrollToBottom();
                    
                    if (socket?.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'file_message',
                            receiver_id: receiverId,
                            file_id: data.message_id,
                            file_name: data.file_name,
                            file_size: data.file_size,
                            file_path: data.file_path,
                            sender_name: currentUser.username
                        }));
                    }
                    
                    showNotification('‚úÖ –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                    cancelFile();
                    
                } else {
                    showNotification(`‚ùå ${data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}`);
                }
            } catch (error) {
                console.error('File upload error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞');
            }
        }

        window.downloadFile = function(messageId) {
            window.open(`/api/files/download/${messageId}`, '_blank');
        };

        // ============================================
        // 12. –°–û–ó–î–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–û–í –°–û–û–ë–©–ï–ù–ò–ô
        // ============================================

        function createMessageElement(sender, text, isReceived, messageId = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = isReceived ? 'message received' : 'message sent';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const reportButton = (!isReceived || !messageId) ? '' : `
                <button class="report-btn" onclick="reportMessage(${messageId}, '${sender}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
                    <i class="fas fa-flag"></i>
                </button>
            `;
            
            if (isReceived) {
                msgDiv.innerHTML = `
                    <div class="message-sender">${escapeHtml(sender)}</div>
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-footer">
                        <span class="message-time">${time}</span>
                        ${reportButton}
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-time">${time}</div>
                `;
            }
            
            return msgDiv;
        }

        function createFileMessageElement(sender, fileData, isReceived, messageId = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = isReceived ? 'message received' : 'message sent';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const fileSize = formatFileSize(fileData.size);
            
            const reportButton = (!isReceived || !messageId) ? '' : `
                <button class="report-btn" onclick="reportMessage(${messageId}, '${sender}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
                    <i class="fas fa-flag"></i>
                </button>
            `;
            
            const fileHtml = `
                <div class="file-message" onclick="downloadFile(${fileData.id})">
                    <div class="file-icon"><i class="fas fa-file"></i></div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(fileData.name)}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                    <div><i class="fas fa-download"></i></div>
                </div>
            `;
            
            if (isReceived) {
                msgDiv.innerHTML = `
                    <div class="message-sender">${escapeHtml(sender)}</div>
                    <div class="message-text">${fileHtml}</div>
                    <div class="message-footer">
                        <span class="message-time">${time}</span>
                        ${reportButton}
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="message-text">${fileHtml}</div>
                    <div class="message-time">${time}</div>
                `;
            }
            
            return msgDiv;
        }

        function addMessageToContainer(sender, text, isReceived) {
            const msg = createMessageElement(sender, text, isReceived);
            document.getElementById('messagesContainer').appendChild(msg);
            scrollToBottom();
        }

        // ============================================
        // 13. –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò
        // ============================================

        async function loadChatHistory(chatId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (demoContacts[chatId]) {
                if (demoContacts[chatId].isChannel) {
                    for (let i = 0; i < 3; i++) {
                        const response = demoContacts[chatId].responses[i % demoContacts[chatId].responses.length];
                        const msg = createChannelMessage(chatId, response);
                        container.appendChild(msg);
                    }
                } else {
                    if (messageHistory[chatId] && messageHistory[chatId].length > 0) {
                        messageHistory[chatId].forEach(msg => container.appendChild(msg));
                    } else {
                        addMessageToContainer('–°–∏—Å—Ç–µ–º–∞', `–ß–∞—Ç —Å ${demoContacts[chatId].name}`, true);
                    }
                }
                scrollToBottom();
                return;
            }
            
            if (chatId.startsWith('user_')) {
                const userId = parseInt(chatId.replace('user_', ''));
                
                try {
                    const response = await fetch(`/api/messages/history/${userId}`);
                    if (response.ok) {
                        const messages = await response.json();
                        messageHistory[userId] = [];
                        
                        messages.forEach(msg => {
                            let msgElement;
                            if (msg.is_file) {
                                msgElement = createFileMessageElement(
                                    msg.sender_name,
                                    {
                                        id: msg.id,
                                        name: msg.file_name,
                                        size: msg.file_size,
                                        path: msg.file_path
                                    },
                                    !msg.is_mine,
                                    msg.id
                                );
                            } else {
                                msgElement = createMessageElement(
                                    msg.sender_name,
                                    msg.content,
                                    !msg.is_mine,
                                    msg.id
                                );
                            }
                            messageHistory[userId].push(msgElement);
                            container.appendChild(msgElement);
                        });
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                }
            }
        }

        function switchToChat(chatId) {
            currentChat.id = chatId;
            
            document.querySelectorAll('.contact').forEach(c => {
                c.classList.remove('active');
                c.style.background = '';
                c.style.borderLeft = '';
            });
            
            const contactElement = document.querySelector(`.contact[data-contact="${chatId}"]`);
            if (contactElement && !contactElement.classList.contains('banned')) {
                contactElement.classList.add('active');
                const nameElement = contactElement.querySelector('div:last-child');
                if (nameElement) {
                    currentChat.name = nameElement.textContent;
                    document.getElementById('chatContactName').textContent = currentChat.name;
                }
            }
            
            if (demoContacts[chatId]?.isChannel) {
                document.getElementById('channelNote').style.display = 'block';
                document.getElementById('messageInputContainer').style.display = 'none';
            } else {
                document.getElementById('channelNote').style.display = 'none';
                document.getElementById('messageInputContainer').style.display = 'flex';
            }
            
            loadChatHistory(chatId);
        }

        // ============================================
        // 14. –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
        // ============================================

        async function searchUser(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                
                if (response.ok) {
                    const users = await response.json();
                    
                    if (users.length === 0) {
                        resultsDiv.innerHTML = '<div style="color: var(--gray); text-align: center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    } else {
                        let html = '';
                        users.forEach(user => {
                            if (user.id !== currentUser.id && user.status !== "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω") {
                                html += `
                                    <div class="search-result" onclick='addUserToContacts(${JSON.stringify(user)})'>
                                        <div class="contact-avatar" style="width: 35px; height: 35px;">üë§</div>
                                        <div>
                                            <div><strong>${escapeHtml(user.username)}</strong></div>
                                            <div style="color: var(--gray); font-size: 12px;">@${escapeHtml(user.tag)}</div>
                                        </div>
                                        <div style="margin-left: auto; color: var(--red);">‚ûï –î–æ–±–∞–≤–∏—Ç—å</div>
                                    </div>
                                `;
                            }
                        });
                        resultsDiv.innerHTML = html || '<div style="color: var(--gray); text-align: center;">–¢–æ–ª—å–∫–æ –≤—ã –∏–ª–∏ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã–µ</div>';
                    }
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.style.display = 'none';
            }
        }

        async function addUserToContacts(user) {
            try {
                if (!currentUser.id) {
                    showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    return;
                }
                
                const formData = new URLSearchParams();
                formData.append('contact_id', user.id);
                formData.append('contact_name', user.username);
                
                const response = await fetch('/api/contacts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                
                if (response.ok) {
                    showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.username} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã`);
                    
                    loadContacts();
                    
                    document.getElementById('userSearch').value = '';
                    document.getElementById('searchResults').style.display = 'none';
                    
                } else {
                    const data = await response.json();
                    showNotification(`‚ùå ${data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏'}`);
                }
            } catch (error) {
                console.error('Add contact error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // ============================================
        // 15. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================

        function showNotification(text) {
            const notif = document.getElementById('notification');
            notif.textContent = text;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function playSound(url) {
            if (!settings.soundEnabled) return;
            const audio = new Audio(url);
            audio.volume = 0.3;
            audio.play().catch(() => {});
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // 16. –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ó–ê–ì–†–£–ó–ö–ê
        // ============================================

        async function checkAuthAndLoadUser() {
            console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...");
            
            try {
                const response = await fetch('/api/me');
                if (response.ok) {
                    const userData = await response.json();
                    console.log("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –¥–∞–Ω–Ω—ã–µ:", userData);
                    
                    if (!userData.error) {
                        currentUser = {
                            id: userData.id,
                            username: userData.username,
                            tag: userData.tag,
                            status: userData.status || '–≤ —Å–µ—Ç–∏',
                            avatar: userData.avatar || 'üë§',
                            is_admin: userData.is_admin || false
                        };
                        updateProfileDisplay();
                        
                        if (currentUser.is_admin) {
                            document.getElementById('adminLink').style.display = 'inline-block';
                        }
                        
                        loadContacts();
                        initWebSocket();
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
            }
            
            console.log("‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
            resetToGuest();
            return false;
        }

        // ============================================
        // 17. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ DOED Messenger starting...');
            
            const isAuthenticated = await checkAuthAndLoadUser();
            
            if (!isAuthenticated && window.location.pathname === '/chat') {
                console.log("üö´ –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...");
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                showNotification("‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...");
            }
            
            switchToChat('derdchat');
            
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') sendMessage(); 
            });
            
            document.getElementById('profileAvatar').addEventListener('click', openProfileModal);
            document.getElementById('profileNameDisplay').addEventListener('click', openProfileModal);
            document.getElementById('saveProfile').addEventListener('click', saveProfile);
            document.getElementById('cancelProfile').addEventListener('click', closeProfileModal);
            
            document.getElementById('profileModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('profileModal')) closeProfileModal();
            });
            
            document.querySelectorAll('.contact').forEach(contact => {
                contact.addEventListener('click', () => {
                    const chatId = contact.getAttribute('data-contact');
                    if (!contact.classList.contains('banned')) {
                        switchToChat(chatId);
                    }
                });
            });
            
            let searchTimeout;
            document.getElementById('userSearch').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                searchTimeout = setTimeout(() => searchUser(query), 500);
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
            
            setInterval(() => {
                if (currentChat.id === 'putin' && !putinDeleted) {
                    addChannelMessage('putin');
                }
                if (currentChat.id === 'gmd' && !gmdDeleted) {
                    addChannelMessage('gmd');
                }
            }, 30000);
            
            setInterval(() => {
                if (demoContacts[currentChat.id] && 
                    !demoContacts[currentChat.id].isChannel && 
                    Math.random() < 0.3) {
                    addBotMessage(currentChat.id);
                }
            }, 15000);
            
            console.log('‚úÖ DOED Messenger ready');
        });

        window.addUserToContacts = addUserToContacts;
        window.switchToChat = switchToChat;
        window.logout = logout;
        window.toggleSound = toggleSound;
        window.addReaction = addReaction;
        window.reportMessage = reportMessage;
        window.cancelFile = cancelFile;
        window.downloadFile = downloadFile;
    </script>
</body>
</html>